<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SarasAI â€” Student Pro (Free)</title>
<style>
:root{
  --bg:#071017; --panel:#0d1418; --muted:#9aa6b2; --accent:#6ad1ff;
  --user:#0e3b4a; --bot:#07212a;
  --bubble-radius:16px;
}
*{box-sizing:border-box}
body{margin:0;height:100%;font-family:Inter,Segoe UI,Arial,system-ui;background:linear-gradient(180deg,var(--bg),#031018);color:#eaf5ff}
.container{max-width:1000px;margin:18px auto;padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 10px 40px rgba(0,0,0,0.6)}
.header{display:flex;align-items:center;gap:12px;justify-content:space-between}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#0ba6e6,#6ad1ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:#04202a}
h1{margin:0;font-size:20px}
.sub{color:var(--muted);font-size:13px}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--panel);border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
.iconbtn{width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center}
.tools{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.tool-btn{background:linear-gradient(90deg,#072c36,#0b2630);border:1px solid rgba(106,209,255,0.08);color:#bff0ff;padding:8px 10px;border-radius:10px;cursor:pointer}
.panel{margin-top:12px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);color:var(--muted)}
.chat-area{display:flex;gap:16px;margin-top:12px}
.left{flex:1}
.right{width:300px}
.chat-wrap{border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));padding:14px;height:560px;overflow:auto;border:1px solid rgba(255,255,255,0.02)}
.messages{display:flex;flex-direction:column;gap:12px}
.msg{max-width:78%;padding:12px 16px;border-radius:var(--bubble-radius);line-height:1.35;word-break:break-word;box-shadow:0 10px 30px rgba(0,0,0,0.45)}
.msg.bot{align-self:flex-start;background:linear-gradient(180deg,var(--bot),#03151b);color:#dff6ff;border-bottom-left-radius:8px}
.msg.user{align-self:flex-end;background:linear-gradient(180deg,var(--user),#063642);color:#e9fbff;border-bottom-right-radius:8px}
.meta{font-size:12px;color:var(--muted);margin-bottom:6px}
.footer{display:flex;gap:8px;align-items:center;margin-top:12px}
.input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:#071218;color:#eaffff}
.small{font-size:13px;color:var(--muted)}
.personality{display:flex;gap:8px;align-items:center}
.personality label{cursor:pointer;padding:6px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.02);color:var(--muted)}
.activeP{background:linear-gradient(90deg,#143b4a,#0c2e3a);color:#bff0ff;border:1px solid rgba(106,209,255,0.15)}
.tools-col{display:flex;flex-direction:column;gap:8px}
.card{background:linear-gradient(180deg,#05121a,#07151a);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);color:var(--muted)}
.search-button{display:inline-block;margin-top:8px;padding:8px 12px;border-radius:8px;background:#072c36;border:1px solid rgba(106,209,255,0.12);color:#bff0ff;cursor:pointer}
.typing-dots{display:inline-block;height:22px;padding:6px;border-radius:12px;background:rgba(255,255,255,0.02)}
.dot{display:inline-block;width:6px;height:6px;margin:0 3px;border-radius:50%;background:#9fdfff;opacity:0.9;animation:blink 1s infinite}
@keyframes blink{0%{opacity:.9}50%{opacity:.2}100%{opacity:.9}}
.link{color:var(--accent);cursor:pointer;text-decoration:underline}
.footer-right{display:flex;flex-direction:column;gap:8px;align-items:flex-end}

/* responsive */
@media(max-width:900px){ .chat-area{flex-direction:column}.right{width:100%} .chat-wrap{height:420px} }
</style>
</head>
<body>
<div class="container" role="application" aria-label="SarasAI Pro">
  <div class="header">
    <div class="brand">
      <div class="logo">S</div>
      <div>
        <h1>SarasAI â€” Student Pro (Free)</h1>
        <div class="sub">Auto-mood â€¢ Teacher mode â€¢ Flashcards â€¢ Pomodoro â€¢ Voice & Text</div>
      </div>
    </div>
    <div class="controls">
      <div class="small">Voice Reply</div>
      <button id="toggleSpeak" class="btn">ON</button>
    </div>
  </div>

  <div class="tools">
    <button id="flashBtn" class="tool-btn">Flashcards</button>
    <button id="quizBtn" class="tool-btn">Quick Quiz</button>
    <button id="summBtn" class="tool-btn">Summarize</button>
    <button id="pomBtn" class="tool-btn">Pomodoro</button>
    <button id="notesBtn" class="tool-btn">Notes</button>
    <button id="exportBtn" class="tool-btn">Export Data</button>
    <button id="importBtn" class="tool-btn">Import Data</button>
  </div>

  <div class="panel card small">SarasAI student mode active. Try: <strong>Solve 2+2</strong>, <strong>Convert 10 km to m</strong>, <strong>How to buy a phone</strong>, or use Flashcards & Quiz.</div>

  <div class="chat-area">
    <div class="left">
      <div class="chat-wrap" id="chat-wrap" aria-live="polite">
        <div id="messages" class="messages">
          <div class="meta">SarasAI ready â€” student-first tools enabled.</div>
        </div>
      </div>

      <div class="footer">
        <button id="micBtn" class="iconbtn">ðŸŽ¤</button>
        <input id="input" class="input" placeholder="Type a message or press mic to speak">
        <button id="sendBtn" class="btn">Send</button>
        <div class="footer-right">
          <div class="personality" id="personalityBar" aria-label="Personality (auto)">
            <label data-p="lovely">Lovely</label>
            <label data-p="teacher">Teacher</label>
            <label data-p="funny">Funny</label>
            <label data-p="caring">Caring</label>
          </div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Study Tools</strong><div class="small">Quick access</div></div>
          <div id="pomStatus" class="small">Pomodoro: stopped</div>
        </div>
        <hr style="border-color:rgba(255,255,255,0.02);margin:8px 0"/>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="showFlash" class="btn">View Flashcards</button>
          <button id="showNotes" class="btn">View Notes</button>
          <button id="showForm" class="btn">Formula Sheet</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div><strong>Quick Tips</strong></div>
        <ul style="padding-left:18px;color:var(--muted);font-size:13px">
          <li>Use flashcards + quiz for revision</li>
          <li>Try Pomodoro for focused sessions</li>
          <li>Click Search web for live prices/results</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- modal root -->
<div id="modalRoot" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;padding:18px;z-index:9999">
  <div id="modal" style="max-width:760px;width:100%;background:#07121a;border-radius:10px;padding:14px;border:1px solid rgba(255,255,255,0.04);color:#e6eef6">
    <div id="modalTitle" style="font-weight:700;margin-bottom:8px"></div>
    <textarea id="modalInput" style="width:100%;height:220px;background:#0b1418;border:1px solid rgba(255,255,255,0.04);color:#e6eef6;padding:8px;border-radius:8px"></textarea>
    <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
      <button id="modalCancel" class="btn">Cancel</button>
      <button id="modalSave" class="btn">Save</button>
    </div>
  </div>
</div>

<script>
/* ---------- SarasAI Pro (Zero-cost, client-only) ---------- */

/* ===== State & Storage keys ===== */
const STORAGE = { FLASH:'saras_flash_v2', NOTES:'saras_notes_v2', FORM:'saras_form_v2' };
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');
const flashBtn = document.getElementById('flashBtn');
const quizBtn = document.getElementById('quizBtn');
const summBtn = document.getElementById('summBtn');
const pomBtn = document.getElementById('pomBtn');
const notesBtn = document.getElementById('notesBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const flashView = document.getElementById('showFlash');
const notesView = document.getElementById('showNotes');
const formView = document.getElementById('showForm');
const toggleSpeak = document.getElementById('toggleSpeak');
const personalityBar = document.getElementById('personalityBar');
const modalRoot = document.getElementById('modalRoot');
const modalTitle = document.getElementById('modalTitle');
const modalInput = document.getElementById('modalInput');
const modalCancel = document.getElementById('modalCancel');
const modalSave = document.getElementById('modalSave');
const pomStatus = document.getElementById('pomStatus');

let voiceReply = true;
let currentPersona = 'lovely'; // auto switches
let oneTimeHandlers = [];
let pomTimer = null, pomRemaining = 0, pomOn = false;

/* ===== Utilities ===== */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function addMessage(text, who='bot', extraHTML=''){
  const div = document.createElement('div');
  div.className = 'msg ' + (who==='user'?'user':'bot');
  const name = (who==='user'?'You':'SarasAI');
  const safe = escapeHtml(text).replace(/\n/g,'<br>');
  div.innerHTML = `<strong>${name}:</strong> ${safe}${extraHTML||''}`;
  messagesEl.appendChild(div);
  document.getElementById('chat-wrap').scrollTop = document.getElementById('chat-wrap').scrollHeight;
}
function addTyping(){
  const div = document.createElement('div'); div.id='typing'; div.className='msg bot';
  div.innerHTML = `<div class="typing-dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>`;
  messagesEl.appendChild(div);
  document.getElementById('chat-wrap').scrollTop = document.getElementById('chat-wrap').scrollHeight;
}
function removeTyping(){ const t=document.getElementById('typing'); if(t) t.remove(); }

/* ===== Mood detection & auto-personality ===== */
function detectMood(text){
  const t = text.toLowerCase();
  const sadWords = ['sad','depressed','upset','stressed','anxious','tired','angry','frustrat','failed','lost'];
  const happyWords = ['happy','great','good','thanks','thanks!','yay','love','excited','cool'];
  const questionStarts = ['how','what','why','explain','define','solve','calculate','help','who','when','where'];
  for(const w of sadWords) if(t.includes(w)) return 'caring';
  for(const w of happyWords) if(t.includes(w)) return 'lovely';
  for(const s of questionStarts) if(t.startsWith(s) || t.includes('how to') || t.includes('solve')) return 'teacher';
  if(t.includes('joke')||t.includes('lol')||t.includes('haha')) return 'funny';
  if(t.endsWith('?')) return 'teacher';
  return null;
}
function autoSwitchPersona(text){
  // Force teacher for clear facts
  if(/^(what is|define|who (?:invented|discovered)|solve|calculate|evaluate|convert)/i.test(text.trim())) {
    setPersona('teacher', true);
    return;
  }
  const mood = detectMood(text);
  if(mood && mood !== currentPersona) setPersona(mood, true);
}
function setPersona(p, auto=false){
  currentPersona = p;
  personalityBar.querySelectorAll('label').forEach(l=>l.classList.remove('activeP'));
  const lbl = personalityBar.querySelector(`label[data-p="${p}"]`);
  if(lbl) lbl.classList.add('activeP');
  if(auto) addMessage(`(Auto) switched personality to: ${p}`, 'bot');
}

/* ===== Storage helpers ===== */
function loadJSON(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)||JSON.stringify(fallback)); } catch(e){ return fallback; } }
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

/* ===== Flashcards ===== */
function loadFlashcards(){ return loadJSON(STORAGE.FLASH, []); }
function saveFlashcards(list){ saveJSON(STORAGE.FLASH, list); }
function createFlashcardsFromInput(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const existing = loadFlashcards();
  let added=0;
  for(const line of lines){
    const sep = line.includes('|') ? '|' : (line.includes('-')?'-':null);
    if(sep){ const [q,a] = line.split(sep).map(s=>s.trim()); if(q){ existing.push({q,a}); added++; } } else { existing.push({q:line,a:''}); added++; }
  }
  saveFlashcards(existing); addMessage(`Saved ${added} flashcards.`, 'bot');
}
function viewFlashcards(){
  const list = loadFlashcards();
  if(!list.length) return addMessage('No flashcards yet. Create some using Flashcards tool.', 'bot');
  addMessage(`You have ${list.length} flashcards:`, 'bot');
  list.slice(0,20).forEach(f=> addMessage(`Q: ${f.q}\nA: ${f.a||'â€”'}`,'bot'));
}

/* ===== Quick Quiz ===== */
function runQuickQuiz(){
  const list = loadFlashcards(); if(!list.length) return addMessage('No flashcards for quiz.', 'bot');
  const pool = [...list]; shuffle(pool);
  const quiz = pool.slice(0, Math.min(5, pool.length));
  let idx=0, score=0;
  addMessage('Starting quick quiz. Answer in chat.', 'bot');
  const ask = ()=>{
    if(idx>=quiz.length){ addMessage(`Quiz finished. Score ${score}/${quiz.length}`, 'bot'); return; }
    addMessage(`Q${idx+1}: ${quiz[idx].q}`, 'bot');
    const one = (ans)=>{
      const correct = normalize(quiz[idx].a);
      const given = normalize(ans);
      if(correct && given && given.includes(correct) || (correct==='' && given.length>0)) { score++; addMessage('Correct!','bot'); }
      else addMessage(`Not quite. Answer: ${quiz[idx].a || 'â€”'}`,'bot');
      idx++; removeOneHandler(one); setTimeout(ask, 300);
    };
    addOneHandler(one);
  };
  ask();
}

/* one-time handlers for quiz */
function addOneHandler(fn){ oneTimeHandlers.push(fn); }
function removeOneHandler(fn){ const i=oneTimeHandlers.indexOf(fn); if(i>=0) oneTimeHandlers.splice(i,1); }
function processOneTime(text){ if(oneTimeHandlers.length){ const f=oneTimeHandlers.shift(); try{ f(text); }catch(e){} return true;} return false; }

/* ===== Pomodoro ===== */
function startPomodoro(minutes=25){
  if(pomOn) return addMessage('Pomodoro already running.', 'bot');
  pomRemaining = minutes*60; pomOn=true;
  pomStatus.textContent = `Pomodoro: ${formatTime(pomRemaining)}`;
  addMessage(`Pomodoro started for ${minutes} minutes. Focus!`, 'bot');
  pomTimer = setInterval(()=>{
    pomRemaining--; pomStatus.textContent = `Pomodoro: ${formatTime(pomRemaining)}`;
    if(pomRemaining<=0){ clearInterval(pomTimer); pomOn=false; pomStatus.textContent='Pomodoro: stopped'; addMessage('Pomodoro finished â€” take a short break!', 'bot'); speak('Pomodoro finished! Take a break.'); }
  },1000);
}
function stopPomodoro(){ if(pomTimer) clearInterval(pomTimer); pomOn=false; pomStatus.textContent='Pomodoro: stopped'; addMessage('Pomodoro stopped.','bot'); }
function formatTime(sec){ const m=Math.floor(sec/60); const s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

/* ===== Notes & formula sheet ===== */
function saveNote(text){ const notes = loadJSON(STORAGE.NOTES, []); notes.push({text,ts:Date.now()}); saveJSON(STORAGE.NOTES, notes); addMessage('Note saved.', 'bot'); }
function viewNotes(){ const notes = loadJSON(STORAGE.NOTES, []); if(!notes.length) return addMessage('No notes saved.', 'bot'); addMessage(`You have ${notes.length} notes:`, 'bot'); notes.slice(-10).reverse().forEach(n=> addMessage(`${new Date(n.ts).toLocaleString()}: ${n.text}`,'bot')); }
function saveFormula(name, value){ const f = loadJSON(STORAGE.FORM, {}); f[name]=value; saveJSON(STORAGE.FORM, f); addMessage(`Saved formula "${name}".`,'bot'); }
function viewFormulas(){ const f = loadJSON(STORAGE.FORM, {}); const keys = Object.keys(f); if(!keys.length) return addMessage('No formulas saved.','bot'); addMessage('Saved formulas:','bot'); keys.forEach(k=> addMessage(`${k}: ${f[k]}`,'bot')); }

/* ===== Export / Import ===== */
function exportAll(){
  const data = { flash: loadFlashcards(), notes: loadJSON(STORAGE.NOTES,[]), form: loadJSON(STORAGE.FORM,{}) };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='sarasai-data.json'; a.click(); URL.revokeObjectURL(url);
  addMessage('Exported study data (download started).', 'bot');
}
function importAll(){
  openModal('Import data (paste JSON)', 'Paste the JSON exported earlier', (val)=>{
    try{
      const j = JSON.parse(val);
      if(j.flash) saveFlashcards(j.flash);
      if(j.notes) saveJSON(STORAGE.NOTES, j.notes);
      if(j.form) saveJSON(STORAGE.FORM, j.form);
      addMessage('Imported data successfully.', 'bot');
    }catch(e){ addMessage('Invalid JSON. Import failed.','bot'); }
  }, '');
}

/* ===== Small helpers ===== */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } }
function normalize(s){ return (s||'').toString().trim().toLowerCase().replace(/[^\w\s]/g,''); }

/* ===== Math & converter (safe) ===== */
function isMathExpression(s){
  const t = s.trim().toLowerCase().replace(/^solve\s+|^calculate\s+|^what is\s+|^evaluate\s+/,'');
  return /^[0-9\s+\-*/().,^%]+$/.test(t);
}
function evalMath(s){
  const t = s.trim().toLowerCase().replace(/^solve\s+|^calculate\s+|^what is\s+|^evaluate\s+/,'').replace(/\^/g,'**').replace(/%/g,'/100');
  if(t.length>200) throw new Error('too long');
  if(!/^[0-9+\-*/().\s*]+$/.test(t.replace(/\*\*/g,'*'))) throw new Error('invalid');
  try{ const r = Function('"use strict";return ('+t+')')(); return String(typeof r==='number' && !Number.isInteger(r) ? parseFloat(r.toFixed(6)) : r); }catch(e){ throw e; }
}
function tryConvert(text){
  const m = text.toLowerCase().match(/convert\s+([\d.]+)\s*(km|m|cm|mm|kg|g|lb|lbs|meter|metre|kilogram|gram)\s+to\s+(km|m|cm|mm|kg|g|lb|lbs|meter|metre|kilogram|gram)/);
  if(!m) return null;
  const val = parseFloat(m[1]); const from = m[2].replace(/meter|metre/,'m').replace(/kilogram/,'kg').replace(/lbs/,'lb'); const to = m[3].replace(/meter|metre/,'m').replace(/kilogram/,'kg').replace(/lbs/,'lb');
  const dist = { km:1000, m:1, cm:0.01, mm:0.001 }; const mass = { kg:1000, g:1, lb:453.59237 };
  if(from in dist && to in dist){ const out=(val*dist[from])/dist[to]; return `${val} ${from} = ${out} ${to}`; }
  if(from in mass && to in mass){ const out=(val*mass[from])/mass[to]; return `${val} ${from} = ${out} ${to}`; }
  return null;
}

/* ===== Short facts & inventor map ===== */
const shortFacts = {
  photosynthesis:"Photosynthesis: plants convert sunlight + COâ‚‚ + water into sugars and oxygen using chlorophyll.",
  gravity:"Gravity is the force that pulls masses toward each other; Newton described the law of universal gravitation and Einstein explained gravity as curvature of spacetime.",
  democracy:"Democracy: a system where people vote to choose leaders or decide on laws.",
  nucleus:"Nucleus: cell's control center storing DNA and managing cell functions."
};
const inventorMap = {
  "gravity":"Gravity was described mathematically by Sir Isaac Newton (17th century); Einstein later explained it as spacetime curvature.",
  "penicillin":"Penicillin was discovered by Alexander Fleming in 1928; Florey & Chain later developed it into a drug.",
  "telephone":"Alexander Graham Bell (1876) is credited with the first practical telephone; others had similar ideas at the same time.",
  "light bulb":"Thomas Edison (1879) made a durable incandescent bulb and a practical lighting system; Joseph Swan and others contributed earlier.",
  "x-ray":"X-rays were discovered by Wilhelm RÃ¶ntgen in 1895.",
  "radio":"Guglielmo Marconi developed practical radio systems; many scientists (Hertz, Tesla, Popov) contributed.",
  "wheel":"The wheel developed in ancient times (~3500â€“3000 BCE); it was not a single inventor but a technological innovation.",
  "computer":"Early concepts by Charles Babbage; modern electronic computers were built by many contributors (Turing, von Neumann, Eckert, Mauchly).",
  "electricity":"Knowledge built over centuries: Franklin, Volta, Faraday, Maxwell and many others advanced electrical science.",
  "vaccination":"Edward Jenner developed the smallpox vaccine concept in the late 18th century using cowpox to protect from smallpox."
};

/* ===== Improved summariser: pick top sentences by keyword frequency ===== */
function summarizeText(paragraph, maxSentences=3){
  if(!paragraph) return '';
  const sents = paragraph.match(/[^.!?]+[.!?]?/g) || [paragraph];
  const textLower = paragraph.toLowerCase();
  const words = textLower.replace(/[^\w\s]/g,'').split(/\s+/).filter(Boolean);
  const freq = {};
  words.forEach(w=>{ if(w.length>3) freq[w] = (freq[w]||0) + 1; });
  const scoreSent = sents.map(sent=>{
    const wordsSent = sent.toLowerCase().replace(/[^\w\s]/g,'').split(/\s+/).filter(Boolean);
    let score = 0; wordsSent.forEach(w=>{ if(freq[w]) score += freq[w]; }); score += Math.min(sent.length/100,2);
    return {sent,score};
  });
  scoreSent.sort((a,b)=>b.score-a.score);
  return scoreSent.slice(0,Math.min(maxSentences, scoreSent.length)).map(x=>x.sent.trim()).join(' ');
}

/* ===== Mini-AI fallback & intelligent pipeline ===== */
function shortExplain(text){ const m=text.toLowerCase().match(/(?:what is|define|definition of)\s+(.+)/); const topic = m?m[1].split(/[?.]/)[0].trim():text; if(shortFacts[topic]) return shortFacts[topic]; return null; }

function miniAIFallback(user){
  const t = user.trim();
  if(isMathExpression(t)){ try{ return "Result: " + evalMath(t); } catch(e){ return "I couldn't calculate that expression. Try simpler math like 2+2."; } }
  const conv = tryConvert(t); if(conv) return conv;
  const expl = shortExplain(t); if(expl) return expl;
  // who invented/discovered pattern
  const whoMatch = t.toLowerCase().match(/who\s+(?:invented|discovered|created|found)\s+(?:the\s+)?(.+?)[?.!]*$/i);
  if(whoMatch){
    const topicRaw = whoMatch[1].trim().toLowerCase().replace(/[?.!]*$/,'');
    if(inventorMap[topicRaw]) return inventorMap[topicRaw];
    for(const key of Object.keys(inventorMap)) if(topicRaw.includes(key)) return inventorMap[key];
    return {text:`I don't have a built-in entry for "${topicRaw}". Many discoveries are results of multiple people. Click Search web for precise history.`, suggestSearch:true};
  }
  if(/summariz|summarise|short summary/i.test(t)) return 'Use the Summarize tool (click Summarize) and paste the paragraph you want summarised.';
  if(/how to buy|buy.*phone|recommend.*phone|which phone/i.test(t)) return 'I can guide buying phones â€” tell me your budget and use (e.g., "Budget 20000 gaming").';
  if(/story|short story/i.test(t)) return "Short story: A student met SarasAI late at night; SarasAI helped and the student smiled.";
  if(/poem|write a poem/i.test(t)) return "A short poem:\nSoft code that listens and replies,\nBrightening study nights and dreams.";
  if(/thank|thanks/i.test(t)) return "You're welcome! ðŸ˜Š";
  return {text:`I don't have a precise built-in answer for: "${t}". Try rephrasing or click Search web.`, suggestSearch:true};
}

/* ===== Process user messages (main pipeline) ===== */
function processUser(text){
  if(!text) return;
  if(processOneTime(text)) return;
  addMessage(text, 'user');

  // Auto-personality & pleasant typing feel
  autoSwitchPersona(text);
  addTyping();

  setTimeout(()=>{
    removeTyping();

    // 1) Math first (if user asked to solve)
    if(isMathExpression(text)){
      try{
        const res = evalMath(text);
        reply(personaWrap("Answer: " + res));
        return;
      }catch(e){}
    }

    // 2) Conversion (convert 10 km to m)
    const conv = tryConvert(text);
    if(conv){
      reply(personaWrap(conv));
      return;
    }

    // 3) DEFINITIONS & "what is / define X" â€” run BEFORE the generic rules
    const s = shortExplain(text);
    if(s){
      reply(personaWrap(s));
      return;
    }

    // 4) Shopping / recommendation intent (student-friendly)
    const shop = handleShoppingIntent(text);
    if(shop){
      reply(personaWrap(shop));
      return;
    }

    // 5) Generic rules (greetings, study tips, etc.)
    const r = matchRules(text);
    if(r){
      reply(personaWrap(r));
      return;
    }

    // 6) mini-AI fallback (stories, poems, assist)
    const mini = miniAIFallback(text);
    if(typeof mini === 'string'){
      reply(personaWrap(mini));
      return;
    }
    if(mini && mini.suggestSearch){
      replyWithSearch(mini.text, text);
      return;
    }

    // 7) final fallback with search helper
    reply(personaWrap("I am not sure. Try rephrasing or click Search web."), true);

  }, 600 + Math.min(1200, text.length * 6));
}

/* ===== Reply helpers ===== */
function reply(msg, showSearch=false){
  addMessage(msg, 'bot');
  if(voiceReply) speak(msg);
}
function replyWithSearch(msg, query){
  const html = `<div style="margin-top:8px"><button class="search-button" onclick="window.open('https://www.google.com/search?q=${encodeURIComponent(query)}','_blank')">Search web for: "${escapeHtml(query)}"</button></div>`;
  addMessage(msg, 'bot', html);
  if(voiceReply) speak(msg);
}
function personaWrap(text){
  if(currentPersona==='lovely') return text + ' ðŸ’™';
  if(currentPersona==='teacher') return 'ðŸ“˜ ' + text;
  if(currentPersona==='funny') return text + ' ðŸ˜‚';
  if(currentPersona==='caring') return 'ðŸ’– ' + text + ' â€” take care!';
  return text;
}

/* ===== Rules & shopping (student-first) ===== */
/* NOTE: removed the generic ['define','what is'] trigger so shortExplain runs first */
const rules = [
  {q:['hello','hi','hey'], a:'Hello! Ready to study or have fun?'},
  {q:['your name','who are you'], a:'I am SarasAI â€” your student helper.'},
  {q:['who created you','creator'], a:'I was created lovingly by Mamatha.'},
  {q:['what can you do','what can you do for me'], a:'I can solve math, create flashcards, summarize text, run quick quizzes, convert units, and suggest study tips.'},
  {q:['study tips','how to study'], a:'Use Pomodoro, active recall (flashcards), and practice problems. Short sessions & spaced repetition help.'},
  {q:['thank you','thanks'], a:'Youâ€™re welcome â€” happy studying!'},
  {q:['help','how to use'], a:'Type a question or press the mic. Try: "Define photosynthesis", "What is gravity", "Solve 2+2", or click Summarize.'}
];
function matchRules(text){
  const t=text.toLowerCase();
  for(const r of rules) for(const kw of r.q) if(t.includes(kw)) return r.a;
  return null;
}

/* ===== Search helper for fallback ===== */
function makeSearchButton(query){
  return `<div><button class="search-button" onclick="window.open('https://www.google.com/search?q=${encodeURIComponent(query)}','_blank')">Search web for: "${escapeHtml(query)}"</button></div>`;
}

/* ===== Speech synthesis & recognition ===== */
function speak(text){
  if(!('speechSynthesis' in window) || !voiceReply) return;
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text.replace(/<[^>]*>/g,''));
    const voices = speechSynthesis.getVoices();
    if(voices && voices.length){ u.voice = voices.find(v=>/female|zira|kyoko|kathy|susan|english/i.test(v.name)) || voices[0]; }
    u.rate = 1;
    speechSynthesis.speak(u);
  }catch(e){ console.warn('speak err', e); }
}
let recognition, listening=false;
if(window.SpeechRecognition || window.webkitSpeechRecognition){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR(); recognition.lang='en-IN'; recognition.interimResults=false; recognition.maxAlternatives=1;
  recognition.onresult = (e)=>{ const t = e.results[0][0].transcript; inputEl.value = t; processUser(t); };
  recognition.onend = ()=>{ listening=false; micBtn.classList.remove('active'); micBtn.title='Start voice input'; };
  recognition.onerror = (ev)=>{ listening=false; micBtn.classList.remove('active'); console.warn(ev); };
} else { micBtn.title = 'Voice input not supported in this browser'; }

/* ===== Event bindings ===== */
sendBtn.addEventListener('click', ()=>{ processUser(inputEl.value.trim()); inputEl.value=''; });
inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ processUser(inputEl.value.trim()); inputEl.value=''; }});
micBtn.addEventListener('click', ()=>{ if(!recognition){ alert('Voice not supported in this browser. Use Chrome/Edge.'); return;} if(listening){ recognition.stop(); listening=false; micBtn.classList.remove('active'); } else { recognition.start(); listening=true; micBtn.classList.add('active'); }});
toggleSpeak.addEventListener('click', ()=>{ voiceReply = !voiceReply; toggleSpeak.textContent = voiceReply ? 'ON':'OFF'; });

flashBtn.addEventListener('click', ()=>{ openModal('Create Flashcards (Q | A per line)', 'Q | A\nExample: What is photosynthesis? | Process by which plants...', (val)=>{ if(val) createFlashcardsFromInput(val); }); });
quizBtn.addEventListener('click', ()=> runQuickQuiz());
summBtn.addEventListener('click', ()=>{ openModal('Summarize text (paste paragraph)', 'Paste paragraph...', (val)=>{ if(!val) return addMessage('No text provided.','bot'); const s = summarizeText(val,3); addMessage('Summary:\n'+s,'bot'); }); });
pomBtn.addEventListener('click', ()=>{ if(!pomOn) startPomodoro(25); else stopPomodoro(); });
notesBtn.addEventListener('click', ()=>{ openModal('Save a quick note', 'Type note...', (val)=>{ if(val) saveNote(val); }); });
exportBtn.addEventListener('click', ()=> exportAll());
importBtn.addEventListener('click', ()=> importAll());
flashView.addEventListener('click', ()=> viewFlashcards());
notesView.addEventListener('click', ()=> viewNotes());
formView.addEventListener('click', ()=> viewFormulas());

/* personality manual click */
personalityBar.querySelectorAll('label').forEach(lbl=>{
  lbl.addEventListener('click', ()=>{ personalityBar.querySelectorAll('label').forEach(l=>l.classList.remove('activeP')); lbl.classList.add('activeP'); currentPersona = lbl.getAttribute('data-p'); addMessage('Personality set to: '+currentPersona,'bot'); });
});

/* modal helpers */
function openModal(title, placeholder, callback, initial=''){
  modalRoot.style.display='flex'; modalTitle.textContent = title; modalInput.value = initial; modalInput.placeholder = placeholder;
  modalSave.onclick = ()=>{ const val = modalInput.value.trim(); modalRoot.style.display='none'; if(callback) callback(val); };
  modalCancel.onclick = ()=>{ modalRoot.style.display='none'; };
}
window.addEventListener('click', e=>{ if(e.target.id==='modalRoot') modalRoot.style.display='none'; });

/* export/import wiring */
function exportAll(){ const data = { flash: loadFlashcards(), notes: loadJSON(STORAGE.NOTES,[]), form: loadJSON(STORAGE.FORM,{}) }; const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='sarasai-data.json'; a.click(); URL.revokeObjectURL(url); addMessage('Export started.','bot'); }
function importAll(){ openModal('Import JSON data (paste)', 'Paste previously exported JSON', (val)=>{ try{ const j=JSON.parse(val); if(j.flash) saveFlashcards(j.flash); if(j.notes) saveJSON(STORAGE.NOTES,j.notes); if(j.form) saveJSON(STORAGE.FORM,j.form); addMessage('Import complete.','bot'); }catch(e){ addMessage('Invalid JSON.','bot'); } }); }

/* ===== Initial ready message ===== */
window.addEventListener('load', ()=>{ setTimeout(()=>{ addMessage('Welcome! SarasAI Student Pro ready â€” try math, conversions, flashcards, summarize, or speak using the mic.'); },200); // ensure voices loaded
  speechSynthesis.getVoices();
});
</script>
</body>
</html>
